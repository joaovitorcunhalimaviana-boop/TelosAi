generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model SystemConfig {
  key   String @id
  value String
}

model ProcessedMessage {
  id        String   @id
  createdAt DateTime @default(now())
}

model User {
  id                           String               @id @default(cuid())
  createdAt                    DateTime             @default(now())
  updatedAt                    DateTime             @updatedAt
  email                        String               @unique
  senha                        String
  nomeCompleto                 String
  crm                          String?
  estado                       String?
  whatsapp                     String?
  role                         String               @default("medico")
  plan                         String               @default("professional")
  basePrice                    Decimal              @default(500) @db.Decimal(10, 2)
  additionalPatientPrice       Decimal              @default(180) @db.Decimal(10, 2)
  isLifetimePrice              Boolean              @default(false)
  maxPatients                  Int                  @default(3)
  currentPatients              Int                  @default(0)
  twilioSubaccountSid          String?
  whatsappNumber               String?
  whatsappConnected            Boolean              @default(false)
  aceitoTermos                 Boolean              @default(false)
  aceitoNovidades              Boolean              @default(false)
  firstLogin                   Boolean              @default(true)
  researchMode                 Boolean              @default(false)
  collectiveIntelligenceDate   DateTime?
  collectiveIntelligenceOptIn  Boolean              @default(false)
  acceptedTermsOfService       Boolean              @default(false)
  termsOfServiceAcceptedAt     DateTime?
  termsOfServiceAcceptedFromIP String?
  termsOfServiceVersion        String?
  auditLogs                    AuditLog[]
  followUps                    FollowUp[]
  followUpResponses            FollowUpResponse[]
  notifications                Notification[]
  passwordResetTokens          PasswordResetToken[]
  patients                     Patient[]
  protocols                    Protocol[]
  pushSubscriptions            PushSubscription[]
  redFlagViews                 RedFlagView[]
  researches                   Research[]
  surgeries                    Surgery[]
  surgeryDetails               SurgeryDetails[]
  surgeryTemplates             SurgeryTemplate[]

  @@unique([crm, estado])
  @@index([email])
  @@index([role])
  @@index([plan])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  userId    String
  token     String   @unique
  expires   DateTime
  used      Boolean  @default(false)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@index([expires])
}

model PushSubscription {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  userId    String
  endpoint  String
  p256dh    String
  auth      String
  userAgent String?
  isActive  Boolean  @default(true)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, endpoint])
  @@index([userId])
  @@index([isActive])
}

model Patient {
  id                    String               @id @default(cuid())
  createdAt             DateTime             @default(now())
  updatedAt             DateTime             @updatedAt
  name                  String
  cpf                   String?              @unique
  dateOfBirth           DateTime?
  age                   Int?
  sex                   String?
  phone                 String
  email                 String?
  isActive              Boolean              @default(true)
  userId                String
  isResearchParticipant Boolean              @default(false)
  researchGroup         String?
  researchNotes         String?
  researchId            String?
  consentTermDate       DateTime?
  consentTermFileUrl    String?
  consentTermSigned     Boolean              @default(false)
  whatsappConsent       Boolean              @default(false)
  isTest                Boolean              @default(false)
  consentTerms          ConsentTerm[]
  conversations         Conversation[]
  followUps             FollowUp[]
  research              Research?            @relation(fields: [researchId], references: [id])
  user                  User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  comorbidities         PatientComorbidity[]
  medications           PatientMedication[]
  surgeries             Surgery[]

  @@index([userId])
  @@index([phone])
  @@index([cpf])
  @@index([isActive])
  @@index([name])
  @@index([researchId])
  @@index([userId, isActive])
}

model Comorbidity {
  id        String               @id @default(cuid())
  name      String               @unique
  category  String
  isActive  Boolean              @default(true)
  createdAt DateTime             @default(now())
  patients  PatientComorbidity[]

  @@index([category])
  @@index([isActive])
}

model PatientComorbidity {
  id            String      @id @default(cuid())
  patientId     String
  comorbidityId String
  details       String?
  severity      String?
  comorbidity   Comorbidity @relation(fields: [comorbidityId], references: [id])
  patient       Patient     @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@unique([patientId, comorbidityId])
  @@index([patientId])
  @@index([comorbidityId])
}

model Medication {
  id        String              @id @default(cuid())
  name      String              @unique
  category  String?
  isActive  Boolean             @default(true)
  createdAt DateTime            @default(now())
  patients  PatientMedication[]

  @@index([category])
  @@index([isActive])
}

model PatientMedication {
  id           String     @id @default(cuid())
  patientId    String
  medicationId String
  dose         String?
  frequency    String?
  route        String?
  medication   Medication @relation(fields: [medicationId], references: [id])
  patient      Patient    @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@index([medicationId])
}

model Surgery {
  id                     String              @id @default(cuid())
  createdAt              DateTime            @default(now())
  updatedAt              DateTime            @updatedAt
  patientId              String
  type                   String
  date                   DateTime
  hospital               String?
  durationMinutes        Int?
  dataCompleteness       Int                 @default(20)
  status                 String              @default("active")
  userId                 String
  mlFeatures             String?
  mlModelVersion         String?
  mlPredictedAt          DateTime?
  predictedRisk          Float?
  predictedRiskLevel     String?
  firstBowelMovementDate DateTime?
  firstBowelMovementDay  Int?
  firstBowelMovementTime String?
  hadFirstBowelMovement  Boolean             @default(false)
  doctorNotes            String?
  anesthesia             Anesthesia?
  consentTerms           ConsentTerm[]
  followUps              FollowUp[]
  postOp                 PostOpPrescription?
  preOp                  PreOpPreparation?
  patient                Patient             @relation(fields: [patientId], references: [id], onDelete: Cascade)
  user                   User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  details                SurgeryDetails?

  @@index([userId])
  @@index([patientId])
  @@index([date])
  @@index([type])
  @@index([predictedRiskLevel])
}

model SurgeryDetails {
  id                        String   @id @default(cuid())
  surgeryId                 String   @unique
  hemorrhoidTechnique       String?
  hemorrhoidEnergyType      String?
  hemorrhoidNumMamillae     Int?
  hemorrhoidPositions       String?
  hemorrhoidType            String?
  hemorrhoidInternalGrade   String?
  hemorrhoidExternalDetails String?
  fistulaType               String?
  fistulaTechnique          String?
  fistulaNumTracts          Int?
  fistulaSeton              Boolean?
  fistulaSetonMaterial      String?
  fissureType               String?
  fissureLocation           String?
  fissureTechnique          String?
  pilonidalTechnique        String?
  fullDescription           String?
  complications             String?
  recoveryRoomMinutes       Int?
  sameDayDischarge          Boolean  @default(true)
  hospitalizationDays       Int?
  userId                    String
  createdAt                 DateTime @default(now())
  surgery                   Surgery  @relation(fields: [surgeryId], references: [id], onDelete: Cascade)
  user                      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([surgeryId])
  @@index([surgeryId, createdAt])
}

model PreOpPreparation {
  id                 String    @id @default(cuid())
  surgeryId          String    @unique
  botoxUsed          Boolean   @default(false)
  botoxDate          DateTime?
  botoxDoseUnits     Int?
  botoxLocation      String?
  botoxObservations  String?
  intestinalPrep     Boolean   @default(false)
  intestinalPrepType String?
  otherPreparations  String?
  surgery            Surgery   @relation(fields: [surgeryId], references: [id], onDelete: Cascade)

  @@index([surgeryId])
}

model Anesthesia {
  id                   String  @id @default(cuid())
  surgeryId            String  @unique
  type                 String
  anesthesiologist     String?
  observations         String?
  pudendoBlock         Boolean @default(false)
  pudendoTechnique     String?
  pudendoAccess        String?
  pudendoAnesthetic    String?
  pudendoConcentration String?
  pudendoVolumeML      Float?
  pudendoLaterality    String?
  pudendoAdjuvants     String?
  pudendoDetails       String?
  surgery              Surgery @relation(fields: [surgeryId], references: [id], onDelete: Cascade)

  @@index([surgeryId])
}

model PostOpPrescription {
  id          String  @id @default(cuid())
  surgeryId   String  @unique
  ointments   String?
  medications String?
  surgery     Surgery @relation(fields: [surgeryId], references: [id], onDelete: Cascade)

  @@index([surgeryId])
}

model ConsentTerm {
  id               String    @id @default(cuid())
  createdAt        DateTime  @default(now())
  patientId        String
  surgeryId        String?
  termType         String
  signedPhysically Boolean   @default(false)
  signedDate       DateTime?
  pdfPath          String?
  patient          Patient   @relation(fields: [patientId], references: [id], onDelete: Cascade)
  surgery          Surgery?  @relation(fields: [surgeryId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@index([surgeryId])
}

model FollowUp {
  id            String             @id @default(cuid())
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  surgeryId     String
  patientId     String
  dayNumber     Int
  scheduledDate DateTime
  status        String             @default("pending")
  sentAt        DateTime?
  respondedAt   DateTime?
  userId        String
  patient       Patient            @relation(fields: [patientId], references: [id], onDelete: Cascade)
  surgery       Surgery            @relation(fields: [surgeryId], references: [id], onDelete: Cascade)
  user          User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  responses     FollowUpResponse[]

  @@index([userId])
  @@index([surgeryId])
  @@index([patientId])
  @@index([scheduledDate])
  @@index([status])
}

model FollowUpResponse {
  id                String        @id @default(cuid())
  createdAt         DateTime      @default(now())
  followUpId        String
  questionnaireData String
  aiAnalysis        String?
  aiResponse        String?
  riskLevel         String        @default("low")
  redFlags          String?
  doctorAlerted     Boolean       @default(false)
  alertSentAt       DateTime?
  userId            String
  painAtRest        Int?
  painDuringBowel   Int?
  bleeding          Boolean?
  fever             Boolean?
  followUp          FollowUp      @relation(fields: [followUpId], references: [id], onDelete: Cascade)
  user              User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  redFlagViews      RedFlagView[]

  @@index([userId])
  @@index([followUpId])
  @@index([riskLevel])
}

model SurgeryTemplate {
  id           String   @id @default(cuid())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  name         String
  surgeryType  String
  templateData String
  isDefault    Boolean  @default(false)
  isActive     Boolean  @default(true)
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([surgeryType])
  @@index([isDefault])
  @@index([isActive])
}

model Research {
  id             String          @id @default(cuid())
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  userId         String
  title          String
  description    String
  isActive       Boolean         @default(true)
  startDate      DateTime        @default(now())
  endDate        DateTime?
  surgeryType    String?
  totalPatients  Int             @default(0)
  requiredFields String[]        @default([]) // Array of field paths like ["name", "phone", "dor_d1"]
  patients       Patient[]
  protocols      Protocol[]
  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  groups         ResearchGroup[]

  @@index([userId])
  @@index([isActive])
  @@index([surgeryType])
}

model ResearchGroup {
  id           String   @id @default(cuid())
  createdAt    DateTime @default(now())
  researchId   String
  groupCode    String
  groupName    String
  description  String
  patientCount Int      @default(0)
  research     Research @relation(fields: [researchId], references: [id], onDelete: Cascade)

  @@unique([researchId, groupCode])
  @@index([researchId])
}

model Protocol {
  id                String    @id @default(cuid())
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  userId            String
  surgeryType       String
  category          String
  title             String
  dayRangeStart     Int
  dayRangeEnd       Int?
  content           String
  priority          Int       @default(0)
  isActive          Boolean   @default(true)
  researchId        String?
  researchGroupCode String?
  research          Research? @relation(fields: [researchId], references: [id], onDelete: Cascade)
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([researchId])
  @@index([researchGroupCode])
  @@index([surgeryType])
  @@index([category])
  @@index([dayRangeStart])
  @@index([isActive])
}

model Notification {
  id        String    @id @default(cuid())
  createdAt DateTime  @default(now())
  userId    String
  type      String
  title     String
  message   String
  priority  String
  read      Boolean   @default(false)
  readAt    DateTime?
  data      Json?
  actionUrl String?
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, read, createdAt])
  @@index([createdAt])
  @@index([priority])
  @@index([type])
}

model RedFlagView {
  id                 String           @id @default(cuid())
  createdAt          DateTime         @default(now())
  userId             String
  followUpResponseId String
  viewedAt           DateTime         @default(now())
  followUpResponse   FollowUpResponse @relation(fields: [followUpResponseId], references: [id], onDelete: Cascade)
  user               User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, viewedAt])
  @@index([followUpResponseId])
}

model AuditLog {
  id           String   @id @default(cuid())
  createdAt    DateTime @default(now())
  userId       String
  action       String
  resource     String
  resourceId   String?
  metadata     Json?
  ipAddress    String
  userAgent    String
  isDataAccess Boolean  @default(false)
  isSensitive  Boolean  @default(false)
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([action])
  @@index([resourceId])
  @@index([createdAt])
}

model Conversation {
  id                  String    @id @default(cuid())
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  patientId           String?
  phoneNumber         String    @unique
  state               String    @default("idle")
  followUpId          String?
  context             Json?
  lastSystemMessage   String?
  lastSystemMessageAt DateTime?
  lastUserMessage     String?
  lastUserMessageAt   DateTime?
  messageHistory      Json?
  patient             Patient?  @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([phoneNumber])
  @@index([patientId])
  @@index([state])
  @@index([followUpId])
  @@index([updatedAt])
}
